name: Create Release

on:
  push:
    tags:
      - '*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Debug repo contents
        run: ls -la

      - name: Create release archives
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Create a temporary folder for the archive
          mkdir release_tmp

          # Copy all repo files (excluding previous archives and .git) into a folder named "wikitsemantics" inside the temp folder
          mkdir release_tmp/wikitsemantics
          rsync -av --progress . release_tmp/wikitsemantics --exclude "wikitsemantics-*.tar.gz" --exclude "wikitsemantics-*.zip" --exclude "wikitsemantics-*.tar.bz2" --exclude ".git"

          # Create a tar.gz archive
          tar -czf wikitsemantics-${VERSION}.tar.gz -C release_tmp wikitsemantics

          # Create a tar.bz2 archive
          tar -cjf wikitsemantics-${VERSION}.tar.bz2 -C release_tmp wikitsemantics

          # Create a zip archive
          cd release_tmp
          zip -r ../wikitsemantics-${VERSION}.zip wikitsemantics
          cd ..

          # Verify that the archives have been created
          ls -lh wikitsemantics-*.tar.gz
          ls -lh wikitsemantics-*.tar.bz2
          ls -lh wikitsemantics-*.zip

          # Remove the temporary folder
          rm -rf release_tmp


      - name: Generate release notes from CHANGELOG.md
        id: release_notes
        run: |
          # Read CHANGELOG.md or fallback to default text
          if [ -f CHANGELOG.md ]; then
            NOTES=$(cat CHANGELOG.md)
          else
            NOTES="No CHANGELOG.md found."
          fi
          # Set output safely for multi-line content
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Wikit Semantics ${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            wikitsemantics-${{ steps.get_version.outputs.VERSION }}.tar.gz
            wikitsemantics-${{ steps.get_version.outputs.VERSION }}.tar.bz2
            wikitsemantics-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}